<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="style.css"/>

    <title></title>


    <script type="text/javascript" src="ajax.js"></script>
    <script>

        function post_to_url(path, params, method) {
            method = method || "post"; // Set method to post by default if not specified.

            // The rest of this code assumes you are not using a library.
            // It can be made less wordy if you use one.
            var form = document.createElement("form");
            form.setAttribute("method", method);
            form.setAttribute("action", path);

            for(var key in params) {
                if(params.hasOwnProperty(key)) {
                    var hiddenField = document.createElement("input");
                    hiddenField.setAttribute("type", "hidden");
                    hiddenField.setAttribute("name", key);
                    hiddenField.setAttribute("value", params[key]);

                    form.appendChild(hiddenField);
                }
            }

            document.body.appendChild(form);
            form.submit();
        }

        function checkUser()
        {
            if (document.getElementById("name").value.length <= 3)
                throw "Username is too short! A username of at least 3 characters is required!";
            ajax("userExists.php?user="+document.getElementById("name").value,userExistsResponse)
        }

        function userExistsResponse()
        {
            if (this.readyState == 4)
            if (this.responseText.match("1")!=null)
                tpr(function(){throw "Username is not available."},"e1b");
            else
                tpr(function(){},"e1b");
        }

        function checkPassFormat()
        {
            if (document.getElementById("pass1").value.length < 6)
                throw "Password is too short! A password of at least 6 characters long is required!";
        }

        function checkPassSame()
        {
            var s1 = document.getElementById("pass1").value;
            var s2 = document.getElementById("pass2").value;
            if (s1.localeCompare(s2) != 0)
                throw "Password mismatch! You must type the same password twice to prevent typos.";
        }

        function validateEmail(email) {
            var re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(email);
        }


        function checkMailFormat()
        {
            var s = document.getElementById("mail1").value;
            var r = validateEmail(s);
            if (!r)
                throw "Bad email format! Emails should look something like john@domain.com";
        }

        function checkMailSame()
        {
            var s1 = document.getElementById("mail1").value;
            var s2 = document.getElementById("mail2").value;
            if (s1.localeCompare(s2) != 0)
                throw "Email mismatch! You must type your email twice to prevent accidental typos.";
        }


        function tpr(f,id)
        {
            var btn = document.getElementById("button")    ;

            try
            {
                f();
                document.getElementById(id).innerHTML = "";
                if (document.getElementsByClassName("error").length == 0)
                    btn.className = "pushbutton";
                else
                    btn.className = "pushbuttonDisabled";
            }
            catch (s)
            {
                document.getElementById(id).innerHTML = "<p class='error'>"+s+"</p>";
                btn.className = "pushbuttonDisabled";
            }
        }

        function submit()
        {
            try
            {
                checkUser();
                checkPassFormat();
                checkPassSame();
                checkMailFormat();
                checkMailSame();

                if (document.getElementsByClassName("error").length > 0)
                    throw "Something is wrong!"

                post_to_url('register.php',
                        {
                            'name': document.getElementById("name").value,
                            'pass': document.getElementById("pass1").value,
                            'mail': document.getElementById("mail1").value
                        });
                /*window.location.href = "register.php?"+
                 "name="+document.getElementById("name").value+"&"+
                 "pass="+sha1(document.getElementById("pass1").value)+"&"+
                 "mail="+document.getElementById("mail1").value+"&";*/
            }
            catch(s)
            {
                document.getElementById("button").className="pushbuttonDisabled";
            }
        }

        document.readyState = function()
        {
            tpr(checkUser,'e1');
            tpr(checkPassFormat,'e2');
            tpr(checkPassSame,'e3');
            tpr(checkMailFormat,'e4');
            tpr(checkMailSame,'e5');
        };

    </script>

</head>
<body>
<div class="box" style="max-width:400px;">
    <div style="margin:auto;padding: 10px;">
    <h1>Register</h1>
    <div style="height:10px"></div>
    <table style="width:100%">
        <tr>
            <td>Username</td>
            <td style="text-align: right">
                <input class="editable" id="name" type="text"  onchange="tpr(checkUser,'e1')"> </input>
            </td>
        </tr>
        <tr>
            <td>Password</td>
            <td style="text-align: right">
                <input class="editable" id="pass1" type="password" onchange="tpr(checkPassFormat,'e2')"> </input>
            </td>
        </tr>
        <tr>
            <td>Password Again</td>
            <td style="text-align: right">
                <input class="editable" id="pass2" type="password" onchange="tpr(checkPassSame,'e3')"> </input>
            </td>
        </tr>
        <tr>
            <td>Email</td>
            <td style="text-align: right">
                <input class="editable" id="mail1" type="text" onchange="tpr(checkMailFormat,'e4')"> </input>
            </td>
        </tr>
        <tr>
            <td>Email Again</td>
            <td style="text-align: right">
                <input class="editable" id="mail2" type="text" onchange="tpr(checkMailSame,'e5')"> </input>
            </td>
        </tr>
    </table>
    <div style="height:10px"></div>
    <div id="e1"></div>
    <div id="e1b"></div>
    <div id="e2"></div>
    <div id="e3"></div>
    <div id="e4"></div>
    <div id="e5"></div>
    <div style="height:10px"></div>
    <div id="button" class="pushbutton" style="text-align: center" onclick="submit()">Submit</div>
    <div style="height:10px"></div>
    </div>
    </div>
</div>

</body>
</html>